// Copyright (c) 2013, the Dart project authors.  Please see the AUTHORS file
// for details. All rights reserved. Use of this source code is governed by a
// BSD-style license that can be found in the LICENSE file.

/**
 * This application displays documentation generated by the docgen tool
 * found at dart-repo/dart/pkg/docgen.
 *
 * The Yaml file outputted by the docgen tool will be read in to
 * generate [Page] and [Category] and [CompositeContainer].
 * Pages, Categories and CategoryItems are used to format and layout the page.
 */
// TODO(janicejl): Add a link to the dart docgen landing page in future.
library web.app;

import 'dart:html' show Element, querySelector, window, ScrollAlignment,
    Event, AnchorElement;

import 'package:polymer/polymer.dart';

import 'shared.dart';
import 'viewer.dart';

import 'package:dartdoc_viewer/location.dart';

/// The [Viewer] object being displayed.
final Viewer viewer = new Viewer();


/// The path of this app on startup.
String _pathname;

/// The latest url reached by a popState event.
String location;

/// The google crawler will try to translate #! anchors into query parameters
/// with an _escaped_fragment_ in front of them. Assume that's the only query
/// parameter.
const _ESCAPED_FRAGMENT = '?_escaped_fragment_=';

/// Listens for browser navigation and acts accordingly.
void startHistory() {
  location = window.location.pathname + window.location.hash;
  // Allow for the location to be in the hash, in the old style.
  var hashLocation = parseFragmentLocation();
  if (hashLocation != null && !hashLocation.isEmpty) {
    location = hashLocation;
  }
  // TODO(alanknight): This won't work on IE9. Not clear if anything will.
  window.onPopState.listen(navigate);
}

/// Read the old-style URL fragment.
String parseFragmentLocation() {
  var hash = locationDeprefixed(window.location.hash);
  return hash.startsWith("id_") ? '' : hash;
}

void navigate(event) {
  // TODO(alanknight): Should we be URI encoding/decoding this?
  var newLocation = window.location.pathname + window.location.hash;
  if (viewer.homePage != null) {
    viewer.handleLink(newLocation, false);
  }
}

/// Handles browser navigation.
@initMethod
void initApp() {
  window.onResize.listen((event) {
    viewer.isDesktop = window.innerWidth > DESKTOP_SIZE_BOUNDARY;
    dartdocMain.collapseSearchAndOptionsIfNeeded();
    dartdocMain.hideOrShowNavigation();
  });

  Polymer.onReady.then((_) {
    dartdocMain.hideOrShowNavigation();
  });

  startHistory();
  // If a user navigates to a page other than the homepage, the viewer
  // must first load fully before navigating to the specified page.
  viewer.finished.then((_) {
    if (location != null && location != '') {
      viewer.handleLink(location);
    } else {
      viewer.currentPage = viewer.startPage;
    }
  });
}
